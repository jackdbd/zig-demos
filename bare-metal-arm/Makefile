CPU=arm926ej-s
PROGRAM=test

.PHONY: all clean help run

help:
	@echo 'help  - Show this help and exit.'
	@echo 'all   - Assemble the startup object file, compile the program into a ELF file and transform it into an ARM binary'
	@echo 'clean - Remove all object files and binaries generated by the ARM assembler and the ARM compiler'
	@echo 'run   - Run the program in the QEMU machine emulator.'

all: $(PROGRAM).bin

startup.o: startup.s
	arm-none-eabi-as -mcpu=$(CPU) -g -o startup.o startup.s --verbose

$(PROGRAM).o: $(PROGRAM).c
	arm-none-eabi-gcc -c -mcpu=$(CPU) -g $(PROGRAM).c -o $(PROGRAM).o

$(PROGRAM).elf: $(PROGRAM).ld $(PROGRAM).o startup.o
	arm-none-eabi-ld --script $(PROGRAM).ld $(PROGRAM).o startup.o -o $(PROGRAM).elf

$(PROGRAM).bin: $(PROGRAM).elf
	arm-none-eabi-objcopy -O binary $(PROGRAM).elf $(PROGRAM).bin --verbose

clean:
	rm -f *.o $(PROGRAM).bin $(PROGRAM).elf

run:
	qemu-system-arm -M versatilepb -m 128M -nographic -kernel $(PROGRAM).bin